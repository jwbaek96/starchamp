<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Vote for your favorite stars from around the world">
    <meta name="theme-color" content="#0f172a">
    
    <!-- PWA Settings -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlN0YXJDaGFtcCIsCiAgInNob3J0X25hbWUiOiAiU3RhckNoYW1wIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZjE3MmEiLAogICJ0aGVtZV9jb2xvciI6ICIjMGYxNzJhIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAibG9nby9sb2dvLnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">
    <link rel="icon" type="image/png" href="logo/logo-removebg.png">
    
    <title>â­ StarChamp - Global Fandom Voting</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f172a;
            color: #f8fafc;
            overflow-x: hidden;
        }
        
        /* Glassmorphism Effect */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        /* Gold Gradient */
        .gold-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
        
        /* Smooth Animations */
        .animate-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
        }
        
        ::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #7c3aed;
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        
        /* Country Flag Emojis */
        .flag {
            font-size: 1.5rem;
        }
        
        /* Hover Effects */
        .hover-lift {
            transition: transform 0.2s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
        }
        
        /* Vote Button Glow */
        .vote-glow {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }

        .logo-glow {
            filter: drop-shadow(0 0 10px rgba(254, 254, 105, 0.899));
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(139, 92, 246, 0.3);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Country Stats Bar */
        .country-bar {
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #8b5cf6 0%, #6d28d9 100%);
        }
        
        /* Hide scrollbar but keep functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 1.25rem;
            right: 1.25rem;
            z-index: 50;
            width: 3.5rem;
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #8b5cf6;
        }

        .fab:hover {
            transform: scale(1.1) rotate(45deg);
            background: rgba(30, 41, 59, 0.9);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* My Page FAB Position */
        .fab-mypage {
            bottom: 5.5rem;
        }

        /* Light Theme Overrides */
        body.light-theme {
            background: #f1f5f9;
            color: #0f172a;
        }

        body.light-theme .fab {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(15, 23, 42, 0.1);
        }

        body.light-theme .glass-card {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(15, 23, 42, 0.1);
        }

        body.light-theme header {
            border-bottom-color: rgba(15, 23, 42, 0.1);
        }

        body.light-theme .text-slate-400 {
            color: #64748b;
        }

        body.light-theme .text-slate-300 {
            color: #334155;
        }

        body.light-theme .bg-slate-900\/50 {
            background: rgba(241, 245, 249, 0.8);
            border-color: #cbd5e1;
            color: #0f172a;
        }

        body.light-theme select, body.light-theme input, body.light-theme textarea {
            background: #ffffff;
            border-color: #cbd5e1;
            color: #0f172a;
        }

        body.light-theme .modal-backdrop {
            background: rgba(0, 0, 0, 0.4);
        }
        .space-y-4 > :not([hidden]) ~ :not([hidden]){
            --tw-space-y-reverse: 0;
            margin-top: 7px !important;
            margin-bottom: calc(1rem * var(--tw-space-y-reverse));
        }
    </style>
</head>
<body class="min-h-screen">
    
    <!-- Main Container -->
    <div id="app" class="min-h-screen">
        
        <!-- Header -->
        <header class="glass-card border-b border-slate-700/50 sticky top-0 z-40">
            <div class="max-w-6xl mx-auto px-2 md:px-4 py-4 flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center gap-2">
                    <img src="logo/logo-removebg.png" alt="StarChamp Logo" class="w-20 h-10 object-contain">
                </div>
                
                <!-- Actions -->
                <div class="flex items-center gap-3">
                    <!-- User Profile / Login -->
                    <div id="authContainer">
                        <button id="loginBtn" class="bg-violet-500 hover:bg-violet-600 text-white px-4 py-2 rounded-full text-sm font-medium active:scale-95 transition-all">
                            <span data-i18n="login">Sign In</span>
                        </button>
                        
                        <div id="userProfile" class="hidden flex items-center gap-2">
                            <div class="flex items-center gap-1.5 bg-violet-500/10 px-3 py-1.5 rounded-full border border-violet-500/20">
                                <i data-lucide="ticket" class="w-4 h-4 text-violet-400"></i>
                                <span id="headerTickets" class="text-sm font-bold text-violet-400">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="max-w-6xl mx-auto px-2 md:px-4 py-3">
            
            <!-- Hero Section -->
            <section class="text-center mb-1 animate-in">
                <!-- <h2 class="text-4xl md:text-5xl font-bold mb-4 tracking-tight">
                    <span data-i18n="hero_title">Vote for Your Champion</span>
                </h2> -->
                <img src="logo/1000012580.png" alt="StarChamp Hero" class="mx-auto mb-0 max-w-full md:max-w-sm logo-glow">
                <!-- <p class="text-slate-400 text-sm md:text-lg mb-2">
                    <span data-i18n="hero_subtitle">Support your favorite stars from around the world</span>
                </p> -->
            </section>
            
            <!-- Search & Filter -->
            <section class="mb-8">
                <div class="glass-card rounded-2xl p-3 md:p-4 flex flex-col md:flex-row gap-3 md:gap-4">
                    <!-- Search Bar -->
                    <div class="flex-1 relative">
                        <i data-lucide="search" class="w-4 h-4 md:w-5 md:h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search stars..."
                            data-i18n-placeholder="search_placeholder"
                            class="w-full bg-slate-900/50 border border-slate-700 rounded-full pl-9 md:pl-10 pr-4 py-1.5 md:py-2 text-sm md:text-base focus:outline-none focus:border-violet-500 transition-colors"
                        >
                    </div>
                    
                    <div class="grid grid-cols-2 md:flex gap-3 md:gap-4">
                        <!-- Category Filter -->
                        <select id="categoryFilter" class="w-full bg-slate-900/50 border border-slate-700 rounded-full px-4 py-1.5 md:py-2 text-sm md:text-base focus:outline-none focus:border-violet-500 transition-colors">
                            <option value="all" data-i18n="all_categories">All Categories</option>
                            <option value="singer" data-i18n="singer">Singer</option>
                            <option value="dancer" data-i18n="dancer">Dancer</option>
                            <option value="comedy" data-i18n="comedy">Comedian</option>
                            <option value="politics" data-i18n="politics">Politician</option>
                            <option value="business" data-i18n="business">Businessperson</option>
                            <option value="ordinary" data-i18n="ordinary">Ordinary Person</option>
                            <option value="other" data-i18n="other">Other</option>
                            <option id="pendingFilterOption" value="pending" class="hidden" data-i18n="pending">Pending</option>
                        </select>
                        
                        <!-- Sort -->
                        <select id="sortFilter" class="w-full bg-slate-900/50 border border-slate-700 rounded-full px-4 py-1.5 md:py-2 text-sm md:text-base focus:outline-none focus:border-violet-500 transition-colors">
                            <option value="votes" data-i18n="sort_votes">Most Votes</option>
                            <option value="recent" data-i18n="sort_recent">Recently Added</option>
                        </select>
                    </div>
                </div>
            </section>
            
            <!-- Ranking List -->
            <section>
                <div id="loadingSpinner" class="flex justify-center items-center py-20">
                    <div class="spinner"></div>
                </div>
                
                <div id="rankingList" class="hidden space-y-4">
                    <!-- Dynamic content will be inserted here -->
                </div>
                
                <div id="emptyState" class="hidden text-center py-20">
                    <i data-lucide="inbox" class="w-16 h-16 mx-auto text-slate-600 mb-4"></i>
                    <p class="text-slate-400" data-i18n="no_results">No Stars found</p>
                </div>
            </section>
            
        </main>
        
        <!-- Footer -->
        <footer class="text-center py-8 text-slate-500 text-sm">
            <p>&copy; 2025 StarChamp. Made with ğŸ’œ for global fandoms.</p>
        </footer>
        
    </div>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-5 right-5 flex flex-col gap-3 z-50">
        <button id="myPageFab" class="fab relative !static hidden">
            <i data-lucide="user" class="w-6 h-6"></i>
        </button>
        <button id="settingsFab" class="fab !static">
            <i data-lucide="settings" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- My Page Modal -->
    <div id="myPageModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6 animate-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl md:text-2xl font-bold" data-i18n="mypage">My Page</h3>
                <button id="closeMyPageModal" class="text-slate-400 hover:text-slate-200 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- User Profile -->
                <div class="p-4 bg-violet-500/10 rounded-2xl border border-violet-500/20">
                    <div class="flex items-center gap-4 mb-4">
                        <img id="myPageUserAvatar" src="" alt="User" class="w-16 h-16 rounded-full border-2 border-violet-500">
                        <div>
                            <div class="flex items-center gap-2">
                                <p id="myPageUserName" class="font-bold text-lg md:text-xl"></p>
                                <span id="adminBadge" class="hidden bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">ADMIN</span>
                            </div>
                            <p id="myPageUserEmail" class="text-xs md:text-sm text-slate-400"></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="glass-card p-3 rounded-xl text-center">
                            <p class="text-xs text-slate-400 mb-1" data-i18n="tickets">Tickets</p>
                            <p id="myPageUserTickets" class="text-xl md:text-2xl font-bold gold-gradient text-transparent bg-clip-text">0</p>
                        </div>
                        <button id="myPageCheckInBtn" class="bg-violet-500 hover:bg-violet-600 text-white rounded-xl flex flex-col items-center justify-center p-2 active:scale-95 transition-all">
                            <i data-lucide="calendar-check" class="w-6 h-6 mb-1"></i>
                            <span class="text-xs font-bold" data-i18n="check_in">Check-in</span>
                        </button>
                    </div>
                </div>

                <!-- My Favorites -->
                <div>
                    <h4 class="text-sm font-bold mb-3 flex items-center gap-2">
                        <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-current"></i>
                        <span data-i18n="my_favorites">My Favorites</span>
                    </h4>
                    <div id="myFavoritesList" class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                        <!-- Dynamic content -->
                    </div>
                </div>

                <!-- My Submissions -->
                <div>
                    <h4 class="text-sm font-bold mb-3 flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4 text-violet-500"></i>
                        <span data-i18n="my_submissions">My Submissions</span>
                    </h4>
                    <div id="myPageSubmissionsList" class="space-y-2 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Dynamic content -->
                    </div>
                </div>

                <!-- Recent Vote History -->
                <div>
                    <h4 class="text-sm font-bold mb-3 flex items-center gap-2">
                        <i data-lucide="history" class="w-4 h-4 text-violet-500"></i>
                        <span data-i18n="vote_history">Vote History</span>
                    </h4>
                    <div id="voteHistoryList" class="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl max-w-sm w-full p-8 animate-in text-center">
            <div class="flex justify-end mb-2">
                <button id="closeLoginModal" class="text-slate-400 hover:text-slate-200 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <img src="logo/logo-removebg.png" alt="StarChamp" class="w-32 mx-auto mb-6">
            
            <h3 class="text-xl md:text-2xl font-bold mb-2" data-i18n="login">Sign In</h3>
            <p class="text-xs md:text-sm text-slate-400 mb-8" data-i18n="hero_subtitle">Support your favorite stars from around the world</p>
            
            <button id="googleLoginBtn" class="w-full bg-white text-slate-900 hover:bg-slate-100 px-6 py-3 rounded-full font-bold flex items-center justify-center gap-3 active:scale-95 transition-all shadow-lg">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span data-i18n="login_google">Sign in with Google</span>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl max-w-sm w-full p-6 animate-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" data-i18n="settings">Settings</h3>
                <button id="closeSettingsModal" class="text-slate-400 hover:text-slate-200 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- Language Setting -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i data-lucide="languages" class="w-5 h-5 text-violet-500"></i>
                        <span class="font-medium" data-i18n="language">Language</span>
                    </div>
                    <button id="langToggle" class="glass-card px-4 py-2 rounded-full text-sm font-bold hover:bg-slate-800/50 active:scale-95 transition-all">
                        <span id="langText">EN</span>
                    </button>
                </div>

                <!-- Theme Setting -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i data-lucide="sun" id="themeIcon" class="w-5 h-5 text-violet-500"></i>
                        <span class="font-medium" data-i18n="theme">Theme</span>
                    </div>
                    <button id="themeToggle" class="glass-card px-4 py-2 rounded-full text-sm font-bold hover:bg-slate-800/50 active:scale-95 transition-all">
                        <span id="themeText" data-i18n="dark_mode">Dark</span>
                    </button>
                </div>

                <!-- Add Star Section -->
                <div class="pt-4 border-t border-slate-700/50">
                    <!-- Admin Dashboard Button (Visible only to admin) -->
                    <button id="adminDashboardBtn" class="hidden w-full bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-full font-bold flex items-center justify-center gap-2 active:scale-95 transition-all mb-3">
                        <i data-lucide="shield-check" class="w-5 h-5"></i>
                        <span>Admin Dashboard</span>
                    </button>

                    <p class="text-sm text-slate-400 mb-4 leading-relaxed" data-i18n="add_star_desc">
                        We create StarChamp together with our users. If you can't find the star you're looking for, please register them!
                    </p>
                    <button id="addStarBtn" class="w-full bg-violet-500 hover:bg-violet-600 text-white px-6 py-3 rounded-full font-medium flex items-center justify-center gap-2 active:scale-95 transition-all mb-3">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        <span data-i18n="add_star">Add New Star</span>
                    </button>
                    
                    <!-- Logout Button (Visible when logged in) -->
                    <button id="logoutBtn" class="hidden w-full glass-card hover:bg-red-500/10 text-red-400 px-6 py-3 rounded-full font-medium flex items-center justify-center gap-2 active:scale-95 transition-all border-red-500/20">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span data-i18n="logout">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Star Modal -->
    <div id="addStarModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6 animate-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl md:text-2xl font-bold" data-i18n="add_star">Add New Star</h3>
                <button id="closeAddModal" class="text-slate-400 hover:text-slate-200 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="addStarForm" class="space-y-4">
                <!-- Name (Korean) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span data-i18n="name_ko">Name (Korean)</span>
                        <span class="text-red-400">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="nameKo" 
                        required
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                        placeholder="ì˜ˆ: ì•„ì´ìœ "
                    >
                </div>
                
                <!-- Name (English) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span data-i18n="name_en">Name (English)</span>
                        <span class="text-red-400">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="nameEn" 
                        required
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                        placeholder="e.g., IU"
                    >
                </div>
                
                <!-- Group (Korean) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span data-i18n="group_ko">Group/Team (Korean)</span>
                    </label>
                    <input 
                        type="text" 
                        id="groupKo" 
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                        placeholder="ì˜ˆ: ë¹…íˆíŠ¸ ì—”í„°í…Œì¸ë¨¼íŠ¸"
                    >
                </div>
                
                <!-- Group (English) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span data-i18n="group_en">Group/Team (English)</span>
                    </label>
                    <input 
                        type="text" 
                        id="groupEn" 
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                        placeholder="e.g., BigHit Entertainment"
                    >
                </div>

                <!-- AI Summary Button -->
                <div class="pt-2">
                    <button 
                        type="button"
                        id="aiSummaryBtn"
                        class="w-full bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-700 hover:to-indigo-700 text-white px-4 py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 active:scale-95 transition-all shadow-lg shadow-indigo-500/20"
                    >
                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                        <span id="aiBtnText">AI ìš”ì•½ ìƒì„± (Gemini)</span>
                    </button>
                </div>
                
                <!-- Description (Korean) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span data-i18n="desc_ko">Description (Korean)</span>
                    </label>
                    <textarea 
                        id="descKo" 
                        rows="3"
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                        placeholder="ê°„ë‹¨í•œ ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                    ></textarea>
                </div>
                
                <!-- Description (English) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span data-i18n="desc_en">Description (English)</span>
                    </label>
                    <textarea 
                        id="descEn" 
                        rows="3"
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                        placeholder="Enter a brief description"
                    ></textarea>
                </div>
                
                <!-- Categories -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span data-i18n="categories">Categories</span>
                        <span class="text-red-400">*</span>
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="singer" class="category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span data-i18n="singer">Singer</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="dancer" class="category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span data-i18n="dancer">Dancer</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="comedy" class="category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span data-i18n="comedy">Comedian</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="politics" class="category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span data-i18n="politics">Politician</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="business" class="category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span data-i18n="business">Businessperson</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="ordinary" class="category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span data-i18n="ordinary">Ordinary Person</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="other" class="category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span data-i18n="other">Other</span>
                        </label>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <div class="flex gap-3 pt-4">
                    <button 
                        type="button"
                        id="cancelAddBtn"
                        class="flex-1 glass-card hover:bg-slate-800/70 px-6 py-3 rounded-full font-medium active:scale-95 transition-all"
                    >
                        <span data-i18n="cancel">Cancel</span>
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 bg-violet-500 hover:bg-violet-600 text-white px-6 py-3 rounded-full font-medium active:scale-95 transition-all"
                    >
                        <span data-i18n="submit">Submit</span>
                    </button>
                </div>
                
                <p class="text-sm text-slate-400 text-center">
                    <span data-i18n="approval_notice">Your submission will be visible after admin approval</span>
                </p>
            </form>
        </div>
    </div>

    <!-- Edit Star Modal (Admin Only) -->
    <div id="editStarModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6 animate-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl md:text-2xl font-bold">Edit Star Info</h3>
                <button id="closeEditModal" class="text-slate-400 hover:text-slate-200 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="editStarForm" class="space-y-4">
                <input type="hidden" id="editStarId">
                <!-- Name (Korean) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span>Name (Korean)</span>
                        <span class="text-red-400">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="editNameKo" 
                        required
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                    >
                </div>
                
                <!-- Name (English) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span>Name (English)</span>
                        <span class="text-red-400">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="editNameEn" 
                        required
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                    >
                </div>
                
                <!-- Group (Korean) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span>Group/Team (Korean)</span>
                    </label>
                    <input 
                        type="text" 
                        id="editGroupKo" 
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                    >
                </div>
                
                <!-- Group (English) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span>Group/Team (English)</span>
                    </label>
                    <input 
                        type="text" 
                        id="editGroupEn" 
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                    >
                </div>

                <!-- AI Summary Button -->
                <div class="pt-2">
                    <button 
                        type="button"
                        id="editAiSummaryBtn"
                        class="w-full bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-700 hover:to-indigo-700 text-white px-4 py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 active:scale-95 transition-all shadow-lg shadow-indigo-500/20"
                    >
                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                        <span id="editAiBtnText">AI ìš”ì•½ ìƒì„± (Gemini)</span>
                    </button>
                </div>
                
                <!-- Description (Korean) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span>Description (Korean)</span>
                    </label>
                    <textarea 
                        id="editDescKo" 
                        rows="3"
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                    ></textarea>
                </div>
                
                <!-- Description (English) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span>Description (English)</span>
                    </label>
                    <textarea 
                        id="editDescEn" 
                        rows="3"
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-violet-500 transition-colors"
                    ></textarea>
                </div>
                
                <!-- Categories -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        <span>Categories</span>
                        <span class="text-red-400">*</span>
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="singer" class="edit-category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span>Singer</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="dancer" class="edit-category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span>Dancer</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="comedy" class="edit-category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span>Comedian</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="politics" class="edit-category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span>Politician</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="business" class="edit-category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span>Businessperson</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="ordinary" class="edit-category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span>Ordinary Person</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="other" class="edit-category-checkbox rounded text-violet-500 focus:ring-violet-500">
                            <span>Other</span>
                        </label>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <div class="flex gap-3 pt-4">
                    <button 
                        type="button"
                        id="cancelEditBtn"
                        class="flex-1 glass-card hover:bg-slate-800/70 px-6 py-3 rounded-full font-medium active:scale-95 transition-all"
                    >
                        <span>Cancel</span>
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 bg-violet-500 hover:bg-violet-600 text-white px-6 py-3 rounded-full font-medium active:scale-95 transition-all"
                    >
                        <span>Save Changes</span>
                    </button>
                </div>
                
                <!-- Admin Approve Button (Hidden by default) -->
                <div id="editApproveContainer" class="hidden pt-2">
                    <button 
                        type="button"
                        id="editApproveBtn"
                        class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-full font-bold active:scale-95 transition-all shadow-lg shadow-green-500/20"
                    >
                        Approve Star
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Star Detail Modal -->
    <div id="detailModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6 animate-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl md:text-2xl font-bold" id="detailName">Star Name</h3>
                <button id="closeDetailModal" class="text-slate-400 hover:text-slate-200 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Star Info -->
            <div class="mb-6">
                <p class="text-xs md:text-sm text-slate-400 mb-2" id="detailGroup"></p>
                <p class="text-sm md:text-base text-slate-300" id="detailDescription"></p>
            </div>
            
            <!-- Total Votes -->
            <div class="glass-card rounded-xl p-4 mb-6 text-center">
                <p class="text-slate-400 text-xs md:text-sm mb-1" data-i18n="total_votes">Total Votes</p>
                <p class="text-3xl md:text-4xl font-bold gold-gradient text-transparent bg-clip-text" id="detailTotalVotes">0</p>
            </div>
            
            <!-- Vote & Favorite Buttons -->
            <div class="flex gap-3 mb-6">
                <button id="voteBtn" class="flex-[2] bg-violet-500 hover:bg-violet-600 text-white vote-glow px-4 md:px-6 py-3 md:py-4 rounded-full font-bold text-base md:text-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="heart" class="w-5 h-5 md:w-6 md:h-6"></i>
                    <span data-i18n="vote_now">Vote Now</span>
                </button>
                <button id="detailFavoriteBtn" class="flex-1 glass-card hover:bg-slate-800/70 px-4 md:px-6 py-3 md:py-4 rounded-full font-bold text-base md:text-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i id="detailFavoriteIcon" data-lucide="star" class="w-5 h-5 md:w-6 md:h-6"></i>
                </button>
            </div>
            
            <!-- Admin Actions -->
            <div id="adminActions" class="hidden mb-6 pt-6 border-t border-slate-700/50">
                <button id="approveStarBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-full font-bold active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                    <span>Approve Star</span>
                </button>
            </div>
            
            <!-- Country Stats -->
            <div>
                <h4 class="font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="globe" class="w-5 h-5"></i>
                    <span data-i18n="votes_by_country">Votes by Country</span>
                </h4>
                <div id="countryStats" class="space-y-3">
                    <!-- Dynamic country stats will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Modal -->
    <div id="adminDashboardModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6 animate-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold flex items-center gap-2">
                    <i data-lucide="shield-check" class="text-red-500"></i>
                    <span>Admin Dashboard</span>
                </h3>
                <button id="closeAdminModal" class="text-slate-400 hover:text-slate-200 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-slate-400 text-sm">Pending Submissions</h4>
                    <button id="refreshAdminList" class="text-violet-400 hover:text-violet-300 text-xs flex items-center gap-1">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        Refresh
                    </button>
                </div>
                
                <div id="adminPendingList" class="space-y-3">
                    <!-- Pending stars will be listed here -->
                    <div class="text-center py-10 text-slate-500">
                        <p>Loading submissions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, increment, updateDoc, doc, serverTimestamp, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { GoogleGenerativeAI } from 'https://esm.run/@google/generative-ai';
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAitPX120P9qm-zcb0G__7HOaRolk7Nv6I",
            authDomain: "starchamp-41abe.firebaseapp.com",
            projectId: "starchamp-41abe",
            storageBucket: "starchamp-41abe.firebasestorage.app",
            messagingSenderId: "17498208702",
            appId: "1:17498208702:web:9d40b8ca6b7a800a2621ef",
            measurementId: "G-SV6C7L3NBH"
        };

        // Gemini API Configuration (Replace with your actual API Key)
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE";
        const genAI = new GoogleGenerativeAI(GEMINI_API_KEY, { apiVersion: "v1" });
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Global State
        let currentLang = 'ko';
        let currentUser = null;
        let userData = null;
        let allStars = [];
        let currentStarId = null;
        let currentTheme = 'light';
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        let isAdmin = false;
        
        // Translation Dictionary
        const translations = {
            ko: {
                login: "ë¡œê·¸ì¸",
                hero_title: "ë‹¹ì‹ ì˜ ìŠ¤íƒ€ì„ ì‘ì›í•˜ì„¸ìš”",
                hero_subtitle: "ì „ ì„¸ê³„ ìŠ¤íƒ€ë¥¼ ì§€ì§€í•˜ê³  íˆ¬í‘œí•˜ì„¸ìš”",
                add_star: "ìŠ¤íƒ€ ì¶”ê°€",
                search_placeholder: "ìŠ¤íƒ€ ê²€ìƒ‰...",
                all_categories: "ì „ì²´ ì¹´í…Œê³ ë¦¬",
                singer: "ê°€ìˆ˜",
                dancer: "ëŒ„ì„œ",
                comedy: "ì½”ë¯¸ë””ì–¸",
                politics: "ì •ì¹˜ì¸",
                business: "ê¸°ì—…ì¸",
                ordinary: "ì¼ë°˜ì¸",
                other: "ê¸°íƒ€",
                sort_votes: "ë“í‘œìˆœ",
                sort_recent: "ìµœì‹ ìˆœ",
                no_results: "ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤",
                name_ko: "ì´ë¦„ (í•œêµ­ì–´)",
                name_en: "ì´ë¦„ (ì˜ì–´)",
                group_ko: "ê·¸ë£¹/ì†Œì† (í•œêµ­ì–´)",
                group_en: "ê·¸ë£¹/ì†Œì† (ì˜ì–´)",
                desc_ko: "ì„¤ëª… (í•œêµ­ì–´)",
                desc_en: "ì„¤ëª… (ì˜ì–´)",
                categories: "ì¹´í…Œê³ ë¦¬",
                cancel: "ì·¨ì†Œ",
                submit: "ì œì¶œ",
                add_star_desc: "ìŠ¤íƒ€ì±”í”„ëŠ” ìœ ì €ì™€ í•¨ê»˜ ë§Œë“¤ì–´ê°€ëŠ” ê³µê°„ì…ë‹ˆë‹¤. ì°¾ëŠ” ìŠ¤íƒ€ê°€ ì—†ë‹¤ë©´ ì§ì ‘ ë“±ë¡í•˜ì—¬ ì‘ì›í•´ë³´ì„¸ìš”!",
                approval_notice: "ê´€ë¦¬ì ìŠ¹ì¸ í›„ í‘œì‹œë©ë‹ˆë‹¤",
                total_votes: "ì´ ë“í‘œìˆ˜",
                vote_now: "ì§€ê¸ˆ íˆ¬í‘œí•˜ê¸°",
                votes_by_country: "êµ­ê°€ë³„ ë“í‘œ í˜„í™©",
                votes: "í‘œ",
                rank: "ìˆœìœ„",
                settings: "ì„¤ì •",
                language: "ì–¸ì–´",
                theme: "í…Œë§ˆ",
                dark_mode: "ë‹¤í¬",
                light_mode: "ë¼ì´íŠ¸",
                login_google: "Googleë¡œ ë¡œê·¸ì¸",
                logout: "ë¡œê·¸ì•„ì›ƒ",
                tickets: "íˆ¬í‘œê¶Œ",
                check_in: "ì¶œì„ì²´í¬",
                check_in_success: "ì¶œì„ì²´í¬ ì™„ë£Œ! íˆ¬í‘œê¶Œ 1ê°œê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ",
                already_checked_in: "ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„ì²´í¬ë¥¼ í•˜ì…¨ìŠµë‹ˆë‹¤.",
                my_submissions: "ë‚´ê°€ ë“±ë¡í•œ ìŠ¤íƒ€",
                pending: "ëŒ€ê¸° ì¤‘",
                approved: "ìŠ¹ì¸ë¨",
                mypage: "ë§ˆì´í˜ì´ì§€",
                my_favorites: "ì¦ê²¨ì°¾ëŠ” ìŠ¤íƒ€",
                vote_history: "ì „ì²´ íˆ¬í‘œ ë‚´ì—­",
                voted_for: "ì—ê²Œ íˆ¬í‘œí•¨"
            },
            en: {
                login: "Sign In",
                hero_title: "Vote for Your Star",
                hero_subtitle: "Support your favorite stars from around the world",
                add_star: "Add New Star",
                search_placeholder: "Search stars...",
                all_categories: "All Categories",
                singer: "Singer",
                dancer: "Dancer",
                comedy: "Comedian",
                politics: "Politician",
                business: "Businessperson",
                ordinary: "Ordinary Person",
                other: "Other",
                sort_votes: "Most Votes",
                sort_recent: "Recently Added",
                no_results: "No stars found",
                name_ko: "Name (Korean)",
                name_en: "Name (English)",
                group_ko: "Group/Team (Korean)",
                group_en: "Group/Team (English)",
                desc_ko: "Description (Korean)",
                desc_en: "Description (English)",
                categories: "Categories",
                cancel: "Cancel",
                submit: "Submit",
                approval_notice: "Your submission will be visible after admin approval",
                total_votes: "Total Votes",
                vote_now: "Vote Now",
                votes_by_country: "Votes by Country",
                votes: "votes",
                rank: "Rank",
                settings: "Settings",
                language: "Language",
                theme: "Theme",
                dark_mode: "Dark",
                add_star_desc: "We create StarChamp together with our users. If you can't find the star you're looking for, please register them!",
                light_mode: "Light",
                login_google: "Sign in with Google",
                logout: "Logout",
                tickets: "Tickets",
                check_in: "Check-in",
                check_in_success: "Check-in complete! 1 ticket granted. ğŸ",
                already_checked_in: "You have already checked in today.",
                my_submissions: "My Submissions",
                pending: "Pending",
                approved: "Approved",
                mypage: "My Page",
                my_favorites: "My Favorites",
                vote_history: "Vote History",
                voted_for: "voted for"
            }
        };
        
        // Country Name Mapping
        const countryNames = {
            KR: { ko: "ğŸ‡°ğŸ‡· ëŒ€í•œë¯¼êµ­", en: "ğŸ‡°ğŸ‡· South Korea" },
            US: { ko: "ğŸ‡ºğŸ‡¸ ë¯¸êµ­", en: "ğŸ‡ºğŸ‡¸ United States" },
            JP: { ko: "ğŸ‡¯ğŸ‡µ ì¼ë³¸", en: "ğŸ‡¯ğŸ‡µ Japan" },
            CN: { ko: "ğŸ‡¨ğŸ‡³ ì¤‘êµ­", en: "ğŸ‡¨ğŸ‡³ China" },
            GB: { ko: "ğŸ‡¬ğŸ‡§ ì˜êµ­", en: "ğŸ‡¬ğŸ‡§ United Kingdom" },
            DE: { ko: "ğŸ‡©ğŸ‡ª ë…ì¼", en: "ğŸ‡©ğŸ‡ª Germany" },
            FR: { ko: "ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤", en: "ğŸ‡«ğŸ‡· France" },
            TH: { ko: "ğŸ‡¹ğŸ‡­ íƒœêµ­", en: "ğŸ‡¹ğŸ‡­ Thailand" },
            VN: { ko: "ğŸ‡»ğŸ‡³ ë² íŠ¸ë‚¨", en: "ğŸ‡»ğŸ‡³ Vietnam" },
            PH: { ko: "ğŸ‡µğŸ‡­ í•„ë¦¬í•€", en: "ğŸ‡µğŸ‡­ Philippines" },
            ID: { ko: "ğŸ‡®ğŸ‡© ì¸ë„ë„¤ì‹œì•„", en: "ğŸ‡®ğŸ‡© Indonesia" },
            BR: { ko: "ğŸ‡§ğŸ‡· ë¸Œë¼ì§ˆ", en: "ğŸ‡§ğŸ‡· Brazil" },
            MX: { ko: "ğŸ‡²ğŸ‡½ ë©•ì‹œì½”", en: "ğŸ‡²ğŸ‡½ Mexico" },
            CA: { ko: "ğŸ‡¨ğŸ‡¦ ìºë‚˜ë‹¤", en: "ğŸ‡¨ğŸ‡¦ Canada" },
            AU: { ko: "ğŸ‡¦ğŸ‡º í˜¸ì£¼", en: "ğŸ‡¦ğŸ‡º Australia" },
            IN: { ko: "ğŸ‡®ğŸ‡³ ì¸ë„", en: "ğŸ‡®ğŸ‡³ India" }
        };
        
        // Initialize
        function init() {
            // Load saved settings
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                currentTheme = savedTheme;
            }
            
            applyTheme();
            updateTranslations();
            setupEventListeners();
            loadStars();
            initLucideIcons();
            
            // Auth State Observer
            onAuthStateChanged(auth, async (user) => {
                console.log("Auth state changed:", user ? "Logged in" : "Logged out");
                currentUser = user;
                if (user) {
                    await syncUserData(user);
                } else {
                    userData = null;
                }
                updateAuthUI(user);
            });
        }

        // Sync User Data with Firestore
        async function syncUserData(user) {
            console.log("Syncing user data for:", user.uid);
            isAdmin = user.email === 'jwbaek96@gmail.com';
            const userRef = doc(db, 'users', user.uid);
            try {
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    console.log("User exists in Firestore, updating...");
                    // Update existing user
                    const existingData = userSnap.data();
                    userData = {
                        ...existingData,
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL
                    };
                    await updateDoc(userRef, {
                        displayName: user.displayName,
                        photoURL: user.photoURL
                    });
                    
                    // Sync favorites from DB to local
                    if (existingData.favorites) {
                        favorites = existingData.favorites;
                        localStorage.setItem('favorites', JSON.stringify(favorites));
                    }
                } else {
                    console.log("New user, creating Firestore document...");
                    // Create new user
                    userData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        tickets: 10, // Initial tickets
                        last_check_in: serverTimestamp(),
                        favorites: favorites, // Use current local favorites
                        created_at: serverTimestamp()
                    };
                    await setDoc(userRef, userData);
                    console.log("User document created successfully");
                }
                
                if (isAdmin) {
                    await loadStars(); // Reload to include pending stars for admin
                } else {
                    renderStars(allStars); // Re-render to show favorites correctly
                }
            } catch (error) {
                console.error("Error syncing user data:", error);
                alert("ë°ì´í„° ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì´ì–´ë² ì´ìŠ¤ ê·œì¹™(Rules)ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        }
        
        // Setup Event Listeners
        function setupEventListeners() {
            // My Page Modal
            document.getElementById('myPageFab').addEventListener('click', openMyPageModal);
            document.getElementById('closeMyPageModal').addEventListener('click', closeMyPageModal);
            document.getElementById('myPageCheckInBtn').addEventListener('click', handleCheckIn);

            // Settings Modal
            document.getElementById('settingsFab').addEventListener('click', openSettingsModal);
            document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('adminDashboardBtn').addEventListener('click', openAdminDashboard);

            // Admin Dashboard Modal
            document.getElementById('closeAdminModal').addEventListener('click', closeAdminDashboard);
            document.getElementById('refreshAdminList').addEventListener('click', loadAdminPendingStars);

            // Edit Star Modal
            document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
            document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
            document.getElementById('editStarForm').addEventListener('submit', handleEditStar);
            document.getElementById('editAiSummaryBtn').addEventListener('click', generateEditAISummary);
            document.getElementById('editApproveBtn').addEventListener('click', () => {
                const starId = document.getElementById('editStarId').value;
                handleAdminApproveFromList(starId);
                closeEditModal();
            });

            // Language Toggle
            document.getElementById('langToggle').addEventListener('click', toggleLanguage);
            
            // Auth Buttons
            document.getElementById('loginBtn').addEventListener('click', openLoginModal);
            document.getElementById('closeLoginModal').addEventListener('click', closeLoginModal);
            document.getElementById('googleLoginBtn').addEventListener('click', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Add Star Modal
            document.getElementById('addStarBtn').addEventListener('click', openAddModal);
            document.getElementById('closeAddModal').addEventListener('click', closeAddModal);
            document.getElementById('cancelAddBtn').addEventListener('click', closeAddModal);
            document.getElementById('addStarForm').addEventListener('submit', handleAddStar);
            document.getElementById('aiSummaryBtn').addEventListener('click', generateAISummary);
            
            // Detail Modal
            document.getElementById('closeDetailModal').addEventListener('click', closeDetailModal);
            document.getElementById('voteBtn').addEventListener('click', () => handleVote());
            document.getElementById('approveStarBtn').addEventListener('click', handleApproveStar);
            document.getElementById('detailFavoriteBtn').addEventListener('click', () => {
                if (currentStarId) {
                    toggleFavorite(currentStarId);
                    // Update icon immediately
                    const isFavorite = favorites.includes(currentStarId);
                    const favIcon = document.getElementById('detailFavoriteIcon');
                    if (isFavorite) {
                        favIcon.classList.add('fill-yellow-400', 'text-yellow-400');
                    } else {
                        favIcon.classList.remove('fill-yellow-400', 'text-yellow-400');
                    }
                }
            });
            
            // Search & Filter
            document.getElementById('searchInput').addEventListener('input', filterStars);
            document.getElementById('categoryFilter').addEventListener('change', filterStars);
            document.getElementById('sortFilter').addEventListener('change', filterStars);
            
            // Close modals on backdrop click
            document.getElementById('addStarModal').addEventListener('click', (e) => {
                if (e.target.id === 'addStarModal') closeAddModal();
            });
            document.getElementById('detailModal').addEventListener('click', (e) => {
                if (e.target.id === 'detailModal') closeDetailModal();
            });
            document.getElementById('settingsModal').addEventListener('click', (e) => {
                if (e.target.id === 'settingsModal') closeSettingsModal();
            });
            document.getElementById('loginModal').addEventListener('click', (e) => {
                if (e.target.id === 'loginModal') closeLoginModal();
            });
            document.getElementById('myPageModal').addEventListener('click', (e) => {
                if (e.target.id === 'myPageModal') closeMyPageModal();
            });
            document.getElementById('adminDashboardModal').addEventListener('click', (e) => {
                if (e.target.id === 'adminDashboardModal') closeAdminDashboard();
            });
        }
        
        // Language Functions
        function toggleLanguage() {
            currentLang = currentLang === 'ko' ? 'en' : 'ko';
            document.getElementById('langText').textContent = currentLang.toUpperCase();
            updateTranslations();
            renderStars(allStars);
        }
        
        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[currentLang][key]) {
                    el.placeholder = translations[currentLang][key];
                }
            });

            // Update theme text specifically
            document.getElementById('themeText').textContent = 
                currentTheme === 'dark' ? translations[currentLang].dark_mode : translations[currentLang].light_mode;
        }

        // Theme Functions
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme();
            localStorage.setItem('theme', currentTheme);
        }

        function applyTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');

            if (currentTheme === 'light') {
                body.classList.add('light-theme');
                themeIcon.setAttribute('data-lucide', 'moon');
                themeText.textContent = translations[currentLang].light_mode;
            } else {
                body.classList.remove('light-theme');
                themeIcon.setAttribute('data-lucide', 'sun');
                themeText.textContent = translations[currentLang].dark_mode;
            }
            initLucideIcons();
        }

        // Modal Functions
        function openMyPageModal() {
            if (!currentUser) {
                openLoginModal();
                return;
            }
            document.getElementById('myPageModal').classList.remove('hidden');
            loadMyFavorites();
            loadVoteHistory();
            loadMySubmissions(currentUser.uid);
        }

        function closeMyPageModal() {
            document.getElementById('myPageModal').classList.add('hidden');
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function openAdminDashboard() {
            if (!isAdmin) return;
            document.getElementById('adminDashboardModal').classList.remove('hidden');
            loadAdminPendingStars();
        }

        function closeAdminDashboard() {
            document.getElementById('adminDashboardModal').classList.add('hidden');
        }

        window.openEditModal = async function(starId) {
            if (!isAdmin) return;
            
            try {
                const starRef = doc(db, 'stars', starId);
                const starSnap = await getDoc(starRef);
                
                if (!starSnap.exists()) {
                    alert("Star not found.");
                    return;
                }
                
                const data = starSnap.data();
                
                // Fill form
                document.getElementById('editStarId').value = starId;
                document.getElementById('editNameKo').value = data.name?.ko || '';
                document.getElementById('editNameEn').value = data.name?.en || '';
                document.getElementById('editGroupKo').value = data.group?.ko || '';
                document.getElementById('editGroupEn').value = data.group?.en || '';
                document.getElementById('editDescKo').value = data.description?.ko || '';
                document.getElementById('editDescEn').value = data.description?.en || '';
                
                // Set categories
                const checkboxes = document.querySelectorAll('.edit-category-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = data.categories?.includes(cb.value);
                });
                
                // Show approve button only if star is pending
                const approveContainer = document.getElementById('editApproveContainer');
                if (!data.is_visible) {
                    approveContainer.classList.remove('hidden');
                } else {
                    approveContainer.classList.add('hidden');
                }
                
                document.getElementById('editStarModal').classList.remove('hidden');
            } catch (error) {
                console.error("Error fetching star for edit:", error);
                alert("Failed to load star data.");
            }
        }

        function closeEditModal() {
            document.getElementById('editStarModal').classList.add('hidden');
        }

        async function handleEditStar(e) {
            e.preventDefault();
            if (!isAdmin) return;

            const starId = document.getElementById('editStarId').value;
            const nameKo = document.getElementById('editNameKo').value.trim();
            const nameEn = document.getElementById('editNameEn').value.trim();
            const groupKo = document.getElementById('editGroupKo').value.trim();
            const groupEn = document.getElementById('editGroupEn').value.trim();
            const descKo = document.getElementById('editDescKo').value.trim();
            const descEn = document.getElementById('editDescEn').value.trim();
            
            const categories = Array.from(document.querySelectorAll('.edit-category-checkbox:checked'))
                .map(cb => cb.value);

            if (categories.length === 0) {
                alert(currentLang === 'ko' ? 'ì¹´í…Œê³ ë¦¬ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.' : 'Please select at least one category.');
                return;
            }

            // Create search key for duplicate checking and searching
            const searchKey = [
                nameKo.toLowerCase(),
                nameEn.toLowerCase(),
                groupKo && nameKo ? `${groupKo} ${nameKo}`.toLowerCase() : null,
                groupEn && nameEn ? `${groupEn} ${nameEn}`.toLowerCase() : null
            ].filter(Boolean);

            try {
                const starRef = doc(db, 'stars', starId);
                await updateDoc(starRef, {
                    name: { ko: nameKo, en: nameEn },
                    group: { ko: groupKo, en: groupEn },
                    description: { ko: descKo, en: descEn },
                    categories: categories,
                    search_key: searchKey,
                    updated_at: serverTimestamp()
                });

                alert(currentLang === 'ko' ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'Updated successfully.');
                closeEditModal();
                loadAdminPendingStars(); // Refresh list
                loadStars(); // Refresh main list
            } catch (error) {
                console.error("Detailed Error updating star:", error);
                if (error.code === 'permission-denied') {
                    alert(currentLang === 'ko' ? 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. Firestore Rulesë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' : 'Permission denied. Check Firestore Rules.');
                } else {
                    alert(currentLang === 'ko' ? 'ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' : 'Failed to update star.');
                }
            }
        }

        async function generateEditAISummary() {
            const nameKo = document.getElementById('editNameKo').value;
            const nameEn = document.getElementById('editNameEn').value;
            const groupKo = document.getElementById('editGroupKo').value;
            
            if (!nameKo && !nameEn) {
                alert(currentLang === 'ko' ? 'ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.' : 'Please enter a name first.');
                return;
            }

            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                alert(currentLang === 'ko' ? 
                    'Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½”ë“œì—ì„œ GEMINI_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.' : 
                    'Gemini API Key is not set. Please set GEMINI_API_KEY in the code.');
                return;
            }

            const btn = document.getElementById('editAiSummaryBtn');
            const btnText = document.getElementById('editAiBtnText');
            const originalText = btnText.textContent;
            
            try {
                btn.disabled = true;
                btnText.textContent = currentLang === 'ko' ? 'ìš”ì•½ ì¤‘...' : 'Summarizing...';

                const prompt = `
                    You are a helpful assistant for a fandom voting app called StarChamp.
                    Create a brief biography (under 5 lines) for the celebrity "${nameKo} (${nameEn})" ${groupKo ? `from the group ${groupKo}` : ''}.
                    
                    Provide the response ONLY in JSON format with two keys: "ko" (Korean) and "en" (English).
                    The tone should be professional and positive.
                    Example: {"ko": "...", "en": "..."}
                `;

                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const result = await model.generateContent(prompt);
                const response = await result.response;
                let text = response.text();
                
                // Clean JSON response if needed
                text = text.replace(/```json|```/g, '').trim();
                const summary = JSON.parse(text);

                if (summary.ko) document.getElementById('editDescKo').value = summary.ko;
                if (summary.en) document.getElementById('editDescEn').value = summary.en;

            } catch (error) {
                console.error('AI Summary Error:', error);
                alert(currentLang === 'ko' ? 'AI ìš”ì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' : 'Failed to generate AI summary.');
            } finally {
                btn.disabled = false;
                btnText.textContent = originalText;
            }
        }

        async function loadAdminPendingStars() {
            const listContainer = document.getElementById('adminPendingList');
            listContainer.innerHTML = `<div class="text-center py-10 text-slate-500"><p>Loading submissions...</p></div>`;

            try {
                // Removed orderBy to avoid requiring a composite index in Firestore
                const q = query(collection(db, 'stars'), where('is_visible', '==', false));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    listContainer.innerHTML = `<div class="text-center py-10 text-slate-500"><p>No pending submissions.</p></div>`;
                    return;
                }

                // Sort in memory to avoid index requirement
                const sortedDocs = [...snapshot.docs].sort((a, b) => {
                    const dateA = a.data().created_at?.toDate() || 0;
                    const dateB = b.data().created_at?.toDate() || 0;
                    return dateB - dateA;
                });

                listContainer.innerHTML = sortedDocs.map(doc => {
                    const data = doc.data();
                    const name = data.name?.ko || data.name?.en || 'Unknown';
                    const group = data.group?.ko || data.group?.en || '';
                    const date = data.created_at?.toDate().toLocaleDateString() || '';
                    
                    return `
                        <div class="glass-card p-4 rounded-xl border border-slate-700/30 flex justify-between items-center">
                            <div>
                                <h5 class="font-bold text-sm">${name}</h5>
                                <p class="text-[10px] text-slate-400">${group} Â· ${date}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="handleAdminApproveFromList('${doc.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold active:scale-95 transition-all">
                                    Approve
                                </button>
                                <button onclick="openEditModal('${doc.id}')" class="glass-card hover:bg-slate-700/50 px-3 py-1.5 rounded-lg text-[10px] font-bold active:scale-95 transition-all">
                                    Edit
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                initLucideIcons();
            } catch (error) {
                console.error("Error loading admin list:", error);
                listContainer.innerHTML = `<div class="text-center py-10 text-red-400"><p>Error loading list.</p></div>`;
            }
        }

        window.handleAdminApproveFromList = async function(starId) {
            if (!confirm('Approve this star?')) return;
            try {
                const starRef = doc(db, 'stars', starId);
                await updateDoc(starRef, { is_visible: true });
                alert('Star approved!');
                loadAdminPendingStars();
                loadStars(); // Refresh main list
            } catch (error) {
                console.error("Error approving star:", error);
                alert('Failed to approve.');
            }
        }

        function openLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
        }
        
        // Auth Functions
        async function handleLogin() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                closeLoginModal();
            } catch (error) {
                console.error('Login error:', error);
                alert(currentLang === 'ko' ? 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' : 'Login failed.');
            }
        }
        
        async function handleLogout() {
            try {
                await signOut(auth);
                closeSettingsModal();
                closeMyPageModal();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async function handleCheckIn() {
            if (!currentUser || !userData) return;

            const now = new Date();
            const lastCheckIn = userData.last_check_in?.toDate?.() || new Date(0);
            
            // Check if already checked in today (KST or local)
            const isSameDay = now.toDateString() === lastCheckIn.toDateString();
            
            if (isSameDay && userData.last_check_in) {
                alert(translations[currentLang].already_checked_in);
                return;
            }

            try {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    tickets: increment(1),
                    last_check_in: serverTimestamp()
                });
                
                userData.tickets += 1;
                userData.last_check_in = { toDate: () => now }; // Mock for UI
                
                updateAuthUI(currentUser);
                alert(translations[currentLang].check_in_success);
            } catch (error) {
                console.error("Check-in error:", error);
            }
        }
        
        async function updateAuthUI(user) {
            const myPageFab = document.getElementById('myPageFab');
            
            if (user) {
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('userProfile').classList.remove('hidden');
                document.getElementById('userProfile').classList.add('flex');
                document.getElementById('headerTickets').textContent = userData ? userData.tickets : 0;
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('flex');
                
                // Show My Page FAB
                myPageFab.classList.remove('hidden');

                // Update My Page Modal Info
                document.getElementById('myPageUserAvatar').src = user.photoURL || '';
                document.getElementById('myPageUserName').textContent = user.displayName || 'User';
                document.getElementById('myPageUserEmail').textContent = user.email || '';
                document.getElementById('myPageUserTickets').textContent = userData ? userData.tickets : 0;
                
                // Show Admin Badge if applicable
                const adminBadge = document.getElementById('adminBadge');
                const adminDashboardBtn = document.getElementById('adminDashboardBtn');
                const pendingFilterOption = document.getElementById('pendingFilterOption');
                if (isAdmin) {
                    adminBadge.classList.remove('hidden');
                    adminDashboardBtn.classList.remove('hidden');
                    if (pendingFilterOption) pendingFilterOption.classList.remove('hidden');
                } else {
                    adminBadge.classList.add('hidden');
                    adminDashboardBtn.classList.add('hidden');
                    if (pendingFilterOption) pendingFilterOption.classList.add('hidden');
                }
                
                initLucideIcons();
            } else {
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('userProfile').classList.add('hidden');
                document.getElementById('userProfile').classList.remove('flex');
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('flex');
                
                // Hide My Page FAB
                myPageFab.classList.add('hidden');
            }
        }

        async function loadMyFavorites() {
            const listContainer = document.getElementById('myFavoritesList');
            if (!favorites.length) {
                listContainer.innerHTML = `<p class="text-xs text-slate-500 text-center py-2">No favorites yet.</p>`;
                return;
            }

            try {
                // Fetch favorite stars
                const favoriteStars = allStars.filter(s => favorites.includes(s.id));
                
                if (favoriteStars.length === 0) {
                    listContainer.innerHTML = `<p class="text-xs text-slate-500 text-center py-2">No favorites yet.</p>`;
                    return;
                }

                listContainer.innerHTML = favoriteStars.map(star => {
                    const name = star.name?.[currentLang] || star.name?.ko || 'Unknown';
                    return `
                        <div class="flex justify-between items-center p-2 bg-slate-800/30 rounded-lg text-xs cursor-pointer hover:bg-slate-800/50" onclick="openDetailModal('${star.id}')">
                            <span class="font-medium truncate">${name}</span>
                            <i data-lucide="chevron-right" class="w-3 h-3 text-slate-500"></i>
                        </div>
                    `;
                }).join('');
                initLucideIcons();
            } catch (error) {
                console.error("Error loading favorites:", error);
            }
        }

        async function loadVoteHistory() {
            const listContainer = document.getElementById('voteHistoryList');
            if (!currentUser) return;

            try {
                const historyRef = collection(db, 'users', currentUser.uid, 'vote_history');
                // Use 'voted_at' to match handleVote and remove limit for "Full History"
                const q = query(historyRef, orderBy('voted_at', 'desc'));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    listContainer.innerHTML = `<p class="text-xs text-slate-500 text-center py-2">No history yet.</p>`;
                    return;
                }

                listContainer.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const starName = data.star_name?.[currentLang] || data.star_name?.ko || 'Star';
                    const date = data.voted_at?.toDate().toLocaleDateString() || '';
                    const time = data.voted_at?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || '';
                    
                    return `
                        <div class="glass-card p-3 rounded-xl flex justify-between items-center border border-slate-700/30">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-slate-500">${date} ${time}</span>
                                <span class="font-bold text-sm text-violet-400">${starName}</span>
                            </div>
                            <div class="flex items-center gap-1 bg-violet-500/10 px-2 py-1 rounded-lg">
                                <i data-lucide="heart" class="w-3 h-3 text-violet-500 fill-current"></i>
                                <span class="text-xs font-bold text-violet-500">+1</span>
                            </div>
                        </div>
                    `;
                }).join('');
                initLucideIcons();
            } catch (error) {
                console.error("Error loading history:", error);
                // If index is missing, it might fail. 
                if (error.message.includes('index')) {
                    listContainer.innerHTML = `<p class="text-[10px] text-amber-400 text-center py-2">Index required. Please check console.</p>`;
                }
            }
        }

        async function loadMySubmissions(uid) {
            const listContainer = document.getElementById('myPageSubmissionsList');
            try {
                const q = query(collection(db, 'stars'), where('creator_uid', '==', uid));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    listContainer.innerHTML = `<p class="text-xs text-slate-500 text-center py-2">No submissions yet.</p>`;
                    return;
                }

                listContainer.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const name = data.name?.[currentLang] || data.name?.ko || 'Unknown';
                    const status = data.is_visible ? 'approved' : 'pending';
                    const statusColor = data.is_visible ? 'text-green-400' : 'text-amber-400';
                    
                    return `
                        <div class="flex justify-between items-center p-2 bg-slate-800/30 rounded-lg text-xs">
                            <span class="font-medium truncate max-w-[120px]">${name}</span>
                            <span class="${statusColor} font-bold" data-i18n="${status}">${translations[currentLang][status]}</span>
                        </div>
                    `;
                }).join('');
                initLucideIcons();
            } catch (error) {
                console.error("Error loading submissions:", error);
            }
        }
        
        // Load Stars from Firestore
        async function loadStars() {
            try {
                document.getElementById('loadingSpinner').classList.remove('hidden');
                document.getElementById('rankingList').classList.add('hidden');
                
                // Admin sees all stars, users see only visible ones
                let q;
                if (isAdmin) {
                    q = query(collection(db, 'stars'));
                } else {
                    q = query(
                        collection(db, 'stars'),
                        where('is_visible', '==', true)
                    );
                }
                
                const snapshot = await getDocs(q);
                allStars = snapshot.docs
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }))
                    .sort((a, b) => (b.votes || 0) - (a.votes || 0));
                
                document.getElementById('loadingSpinner').classList.add('hidden');
                renderStars(allStars);
                
            } catch (error) {
                console.error('Error loading stars:', error);
                document.getElementById('loadingSpinner').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }
        
        // Render Stars List
        function renderStars(stars) {
            const container = document.getElementById('rankingList');
            
            if (stars.length === 0) {
                container.classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            
            let currentRank = 1;
            container.innerHTML = stars.map((star, index) => {
                const name = star.name?.[currentLang] || star.name?.ko || 'Unknown';
                const group = star.group?.[currentLang] || star.group?.ko || '';
                const votes = star.votes || 0;
                const isFavorite = favorites.includes(star.id);
                
                // Get translated categories
                const categoryList = (star.categories || [])
                    .map(cat => translations[currentLang][cat] || cat)
                    .join(', ');
                const subtitle = group ? `${group} Â· ${categoryList}` : categoryList;
                
                // Handle ties: if votes are same as previous star, use same rank
                if (index > 0 && votes < stars[index - 1].votes) {
                    currentRank = index + 1;
                }
                
                const pendingBadge = (isAdmin && !star.is_visible) 
                    ? `<span class="bg-amber-500/20 text-amber-400 text-[10px] px-1.5 py-0.5 rounded-full font-bold border border-amber-500/30 ml-2">PENDING</span>` 
                    : '';
                
                const rankDisplay = `<div class="text-slate-500 text-lg md:text-xl font-bold w-8 md:w-12 text-center">#${currentRank}</div>`;
                
                // If admin and star is pending, open edit modal instead of detail modal
                const clickHandler = (isAdmin && !star.is_visible) 
                    ? `openEditModal('${star.id}')` 
                    : `openDetailModal('${star.id}')`;

                return `
                    <div class="glass-card rounded-2xl p-3 md:p-1 hover:bg-slate-800/50 cursor-pointer active:scale-[0.98] transition-all hover-lift animate-in" onclick="${clickHandler}">
                        <div class="flex items-center gap-2 md:gap-4">
                            ${rankDisplay}
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-0.5">
                                    <h3 class="font-bold text-sm md:text-lg truncate">${name}${pendingBadge}</h3>
                                    <span class="text-[10px] md:text-sm font-bold gold-gradient text-transparent bg-clip-text">${votes.toLocaleString()} ${translations[currentLang].votes}</span>
                                </div>
                                <p class="text-[10px] md:text-sm text-slate-400 truncate">${subtitle}</p>
                            </div>
                            <div class="flex items-center gap-1">
                                <!-- Quick Vote Button -->
                                <button onclick="event.stopPropagation(); handleQuickVote('${star.id}')" class="bg-violet-500 hover:bg-violet-600 text-white p-1.5 md:p-2 rounded-full active:scale-90 transition-all shadow-lg shadow-violet-500/20">
                                    <i data-lucide="heart" class="w-4 h-4 md:w-5 md:h-5 fill-current"></i>
                                </button>
                                <!-- Favorite Button -->
                                <button onclick="event.stopPropagation(); toggleFavorite('${star.id}')" class="p-1.5 md:p-2 hover:bg-slate-700/50 rounded-full transition-colors group">
                                    <i data-lucide="star" class="w-4 h-4 md:w-5 md:h-5 ${isFavorite ? 'fill-yellow-400 text-yellow-400' : 'text-slate-400 group-hover:text-yellow-400'}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            initLucideIcons();
        }
        
        // Filter Stars
        function filterStars() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortFilter').value;
            
            let filtered = allStars.filter(star => {
                // Search filter
                const nameKo = star.name?.ko?.toLowerCase() || '';
                const nameEn = star.name?.en?.toLowerCase() || '';
                const groupKo = star.group?.ko?.toLowerCase() || '';
                const groupEn = star.group?.en?.toLowerCase() || '';
                const searchMatch = nameKo.includes(searchTerm) || nameEn.includes(searchTerm) || 
                                  groupKo.includes(searchTerm) || groupEn.includes(searchTerm);
                
                // Category filter
                let categoryMatch = false;
                if (category === 'all') {
                    categoryMatch = true;
                } else if (category === 'pending') {
                    categoryMatch = star.is_visible === false;
                } else {
                    categoryMatch = star.categories && star.categories.includes(category);
                }
                
                return searchMatch && categoryMatch;
            });
            
            // Sort
            if (sortBy === 'votes') {
                filtered.sort((a, b) => (b.votes || 0) - (a.votes || 0));
            } else if (sortBy === 'recent') {
                filtered.sort((a, b) => {
                    const aTime = a.created_at?.toMillis?.() || 0;
                    const bTime = b.created_at?.toMillis?.() || 0;
                    return bTime - aTime;
                });
            }
            
            renderStars(filtered);
        }
        
        // Modal Functions
        function openAddModal() {
            if (!currentUser) {
                alert(currentLang === 'ko' ? 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' : 'Please sign in first.');
                return;
            }
            closeSettingsModal();
            document.getElementById('addStarModal').classList.remove('hidden');
        }
        
        function closeAddModal() {
            document.getElementById('addStarModal').classList.add('hidden');
            document.getElementById('addStarForm').reset();
        }
        
        window.openDetailModal = async function(starId) {
            currentStarId = starId;
            const star = allStars.find(s => s.id === starId);
            
            if (!star) return;
            
            document.getElementById('detailName').textContent = star.name?.[currentLang] || star.name?.ko || 'Unknown';
            document.getElementById('detailGroup').textContent = star.group?.[currentLang] || star.group?.ko || '';
            document.getElementById('detailDescription').textContent = star.description?.[currentLang] || star.description?.ko || '';
            document.getElementById('detailTotalVotes').textContent = (star.votes || 0).toLocaleString();
            
            // Update Favorite Button in Detail
            const isFavorite = favorites.includes(starId);
            const favIcon = document.getElementById('detailFavoriteIcon');
            if (isFavorite) {
                favIcon.classList.add('fill-yellow-400', 'text-yellow-400');
            } else {
                favIcon.classList.remove('fill-yellow-400', 'text-yellow-400');
                favIcon.classList.add('text-slate-400');
            }
            
            // Render country stats
            renderCountryStats(star.votes_by_country || {}, star.votes || 0);
            
            // Admin Actions
            const adminActions = document.getElementById('adminActions');
            if (isAdmin && !star.is_visible) {
                adminActions.classList.remove('hidden');
            } else {
                adminActions.classList.add('hidden');
            }
            
            document.getElementById('detailModal').classList.remove('hidden');
            initLucideIcons();
        };
        
        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
            currentStarId = null;
        }
        
        function renderCountryStats(votesByCountry, totalVotes) {
            const container = document.getElementById('countryStats');
            
            if (totalVotes === 0) {
                container.innerHTML = `<p class="text-slate-400 text-center py-4">${currentLang === 'ko' ? 'ì•„ì§ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤' : 'No votes yet'}</p>`;
                return;
            }
            
            // Sort countries by votes
            const sortedCountries = Object.entries(votesByCountry)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10); // Top 10 countries
            
            container.innerHTML = sortedCountries.map(([countryCode, votes]) => {
                const percentage = ((votes / totalVotes) * 100).toFixed(1);
                const countryName = countryNames[countryCode]?.[currentLang] || `${countryCode}`;
                
                return `
                    <div class="space-y-1">
                        <div class="flex justify-between text-sm">
                            <span>${countryName}</span>
                            <span class="text-slate-400">${votes.toLocaleString()} (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden">
                            <div class="country-bar h-full rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // AI Summary Generator using Gemini
        async function generateAISummary() {
            const nameKo = document.getElementById('nameKo').value.trim();
            const nameEn = document.getElementById('nameEn').value.trim();
            const groupKo = document.getElementById('groupKo').value.trim();
            const groupEn = document.getElementById('groupEn').value.trim();

            if (!nameKo && !nameEn) {
                alert(currentLang === 'ko' ? 'ìŠ¤íƒ€ì˜ ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.' : 'Please enter the star\'s name first.');
                return;
            }

            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                alert(currentLang === 'ko' ? 
                    'Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½”ë“œì—ì„œ GEMINI_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.' : 
                    'Gemini API Key is not set. Please set GEMINI_API_KEY in the code.');
                return;
            }

            const btn = document.getElementById('aiSummaryBtn');
            const btnText = document.getElementById('aiBtnText');
            const originalText = btnText.textContent;

            try {
                btn.disabled = true;
                btn.classList.add('opacity-70', 'cursor-not-allowed');
                btnText.textContent = currentLang === 'ko' ? 'AI ìš”ì•½ ìƒì„± ì¤‘...' : 'Generating AI Summary...';

                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                
                const prompt = `
                    You are a helpful assistant for a fandom voting app called StarChamp.
                    Create a brief biography (under 5 lines) for the celebrity "${nameKo} (${nameEn})" ${groupKo ? `from the group ${groupKo}` : ''}.
                    
                    Provide the response ONLY in JSON format with two keys: "ko" (Korean) and "en" (English).
                    The tone should be professional and positive.
                    Example: {"ko": "...", "en": "..."}
                `;

                const result = await model.generateContent(prompt);
                const response = await result.response;
                let text = response.text();

                // Clean JSON response (remove markdown code blocks if present)
                text = text.replace(/```json|```/g, '').trim();
                const summary = JSON.parse(text);

                if (summary.ko) document.getElementById('descKo').value = summary.ko;
                if (summary.en) document.getElementById('descEn').value = summary.en;

            } catch (error) {
                console.error('AI Summary Error:', error);
                alert(currentLang === 'ko' ? 'AI ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' : 'Error generating AI summary.');
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
                btnText.textContent = originalText;
            }
        }
        
        // Add Star Handler
        async function handleAddStar(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert(currentLang === 'ko' ? 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' : 'Please sign in first.');
                return;
            }
            
            const nameKo = document.getElementById('nameKo').value.trim();
            const nameEn = document.getElementById('nameEn').value.trim();
            const groupKo = document.getElementById('groupKo').value.trim();
            const groupEn = document.getElementById('groupEn').value.trim();
            const descKo = document.getElementById('descKo').value.trim();
            const descEn = document.getElementById('descEn').value.trim();
            
            const categoryCheckboxes = document.querySelectorAll('.category-checkbox:checked');
            const categories = Array.from(categoryCheckboxes).map(cb => cb.value);
            
            if (categories.length === 0) {
                alert(currentLang === 'ko' ? 'ìµœì†Œ í•˜ë‚˜ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.' : 'Please select at least one category.');
                return;
            }
            
            // Create search key for duplicate checking
            // Removed standalone group names to allow multiple stars from the same group
            const searchKey = [
                nameKo.toLowerCase(),
                nameEn.toLowerCase(),
                groupKo && nameKo ? `${groupKo} ${nameKo}`.toLowerCase() : null,
                groupEn && nameEn ? `${groupEn} ${nameEn}`.toLowerCase() : null
            ].filter(Boolean);
            
            try {
                // Check for duplicates using array-contains-any (more efficient)
                const q = query(
                    collection(db, 'stars'),
                    where('search_key', 'array-contains-any', searchKey)
                );
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    alert(currentLang === 'ko' ? 
                        'ì´ë¯¸ ë“±ë¡ëœ ìŠ¤íƒ€ì…ë‹ˆë‹¤.' : 
                        'This star has already been registered.');
                    return;
                }
                
                // Add to Firestore
                await addDoc(collection(db, 'stars'), {
                    name: { ko: nameKo, en: nameEn },
                    group: { ko: groupKo, en: groupEn },
                    description: { ko: descKo, en: descEn },
                    categories: categories,
                    search_key: searchKey,
                    votes: 0,
                    votes_by_country: {},
                    is_visible: false, // Requires admin approval
                    creator_uid: currentUser.uid,
                    created_at: serverTimestamp()
                });
                
                alert(currentLang === 'ko' ? 
                    'ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ê´€ë¦¬ì ìŠ¹ì¸ í›„ í‘œì‹œë©ë‹ˆë‹¤.' : 
                    'Submitted! It will be visible after admin approval.');
                
                closeAddModal();
                
            } catch (error) {
                console.error('Error adding star:', error);
                alert(currentLang === 'ko' ? 
                    `ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}` : 
                    `An error occurred: ${error.message}`);
            }
        }
        
        // Admin Handler
        async function handleApproveStar() {
            if (!isAdmin || !currentStarId) return;
            
            try {
                const starRef = doc(db, 'stars', currentStarId);
                await updateDoc(starRef, {
                    is_visible: true
                });
                alert(currentLang === 'ko' ? "ìŠ¤íƒ€ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!" : "Star approved successfully!");
                closeDetailModal();
                await loadStars(); // Reload list to show approved star
            } catch (error) {
                console.error("Error approving star:", error);
                alert(currentLang === 'ko' ? "ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." : "Failed to approve star.");
            }
        }
        
        // Vote Handler
        async function handleVote(starId = null) {
            const targetId = starId || currentStarId;
            if (!currentUser) {
                openLoginModal();
                return;
            }
            
            if (!targetId) return;

            // Check if star is approved
            const star = allStars.find(s => s.id === targetId);
            if (star && star.is_visible === false) {
                alert(currentLang === 'ko' ? 'ê´€ë¦¬ì ìŠ¹ì¸ ì „ì¸ ìŠ¤íƒ€ì…ë‹ˆë‹¤.' : 'This star is pending admin approval.');
                return;
            }

            // Check tickets
            if (!userData || userData.tickets <= 0) {
                alert(currentLang === 'ko' ? 'íˆ¬í‘œê¶Œì´ ë¶€ì¡±í•©ë‹ˆë‹¤.' : 'Not enough tickets.');
                return;
            }
            
            try {
                // Get user's country from IP
                const countryCode = await getUserCountry();
                
                // 1. Update Star Votes
                const starRef = doc(db, 'stars', targetId);
                await updateDoc(starRef, {
                    votes: increment(1),
                    [`votes_by_country.${countryCode}`]: increment(1)
                });

                // 2. Update User Tickets
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    tickets: increment(-1)
                });
                userData.tickets -= 1;

                // 3. Record Vote History
                const historyRef = collection(db, 'users', currentUser.uid, 'vote_history');
                await addDoc(historyRef, {
                    star_id: targetId,
                    star_name: allStars.find(s => s.id === targetId)?.name || {},
                    voted_at: serverTimestamp(),
                    country: countryCode
                });
                
                alert(currentLang === 'ko' ? 'íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰' : 'Vote counted! ğŸ‰');
                
                // Reload data
                updateAuthUI(currentUser);
                await loadStars();
                if (!starId) closeDetailModal();
                
            } catch (error) {
                console.error('Error voting:', error);
                alert(currentLang === 'ko' ? 
                    'íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' : 
                    'An error occurred while voting.');
            }
        }

        // Favorite Handler
        async function toggleFavorite(starId) {
            const index = favorites.indexOf(starId);
            if (index === -1) {
                favorites.push(starId);
            } else {
                favorites.splice(index, 1);
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            
            // Sync with Firestore if logged in
            if (currentUser) {
                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    await updateDoc(userRef, {
                        favorites: favorites
                    });
                } catch (error) {
                    console.error("Error updating favorites in DB:", error);
                }
            }
            
            renderStars(allStars);
        }

        // Quick Vote Handler
        function handleQuickVote(starId) {
            handleVote(starId);
        }
        
        // Get User Country from IP
        async function getUserCountry() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                return data.country_code || 'XX';
            } catch (error) {
                console.error('Error getting country:', error);
                return 'XX';
            }
        }
        
        // Initialize Lucide Icons
        function initLucideIcons() {
            if (window.lucide) {
                lucide.createIcons();
            }
        }
        
        // Start App
        init();
        
        // Make functions globally accessible
        window.openDetailModal = openDetailModal;
        window.toggleFavorite = toggleFavorite;
        window.handleQuickVote = handleQuickVote;
    </script>
</body>
</html>